---
layout: post
title: Cloudflare æ¢ç´¢ä¹‹ä¸ºç½‘ç«™å…è´¹ HTTPS
date: 2025-02-22 20:00:00 +0800
categories: ç¬”è®°
tags: æŠ€æœ¯
excerpt: å€ŸåŠ© Cloudflare è®©æˆ‘ä»¬è‡ªå·±éƒ¨ç½²çš„ä¸ªäººç½‘ç«™ä½¿ç”¨å…è´¹çš„ HTTPS è¿æ¥ã€‚
---

![Cloudflare flexible Cover](/assets/images/cloudflare/cf-flexible-connect2.webp "é¢˜å›¾")

## ç›®å½•

- [1. å¼•æ–‡](#1-å¼•æ–‡)
- [2. Cloudflare æ˜¯ä»€ä¹ˆ](#2-cloudflare-æ˜¯ä»€ä¹ˆ)
- [3. Cloudflare å†å²](#3-cloudflare-å†å²)
- [4. é—®é¢˜æè¿°](#4-é—®é¢˜æè¿°)
  - [4.1. é—®é¢˜ä¸€](#41-é—®é¢˜ä¸€)
  - [4.2. é—®é¢˜äºŒ](#42-é—®é¢˜äºŒ)
- [5. éœ€æ±‚åˆ†æ](#5-éœ€æ±‚åˆ†æ)
- [6. è§£å†³æ–¹æ¡ˆ](#6-è§£å†³æ–¹æ¡ˆ)
  - [6.1. é—®é¢˜ä¸€è§£æ³•](#61-é—®é¢˜ä¸€è§£æ³•)
  - [6.2. é—®é¢˜äºŒè§£æ³•](#62-é—®é¢˜äºŒè§£æ³•)
- [7. æ“ä½œæ­¥éª¤](#7-æ“ä½œæ­¥éª¤)
- [8. å‚è€ƒ](#8-å‚è€ƒ)

## 1. å¼•æ–‡

ä¹¦æ¥ä¸Šæ–‡ï¼ˆ[Cloudflare æ¢ç´¢ä¹‹è®©æµè§ˆå™¨æ˜¾ç¤ºå®‰å…¨è®¿é—®ç½‘é¡µ\[1\]][1]ï¼‰ã€‚ä¸Šæ–‡ä»‹ç»äº†ä½¿ç”¨ [Cloudflare\[2\]][2] å°†æˆ‘ä»¬çš„ç½‘ç«™åŒ…è£…æˆèƒ½ HTTPS åŠ å¯†
ä¼ è¾“çš„ç½‘ç«™ï¼Œä½†æ˜¯é‚£åªæ˜¯ä¸€ä¸ªåŠæˆå“ï¼Œåœ¨ã€ç»ˆç«¯ -ğŸ”-> CF èŠ‚ç‚¹ã€‘ä¹‹é—´æ˜¯åŠ å¯†çš„ï¼Œä½†ã€CF èŠ‚ç‚¹ -> åº”ç”¨æœåŠ¡å™¨ã€‘
ä¹‹é—´è¿˜æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œè¡¨é¢çœ‹æ˜¯å®Œç¾ï¼Œå®è´¨è¿˜æ˜¯ä¸å®Œç¾ï¼Œå¯¹äºæœ‰å®‰å…¨æ€§è¦æ±‚çš„ç«™ç‚¹æ¥è¯´ï¼Œæ˜¯è¾¾ä¸åˆ°è¦æ±‚çš„ï¼Œæ²¡èƒ½å®Œå…¨è§£å†³å®é™…é—®é¢˜ã€‚

è¿™ä¸€ç¯‡æ˜¯ç©¶æå®Œå…¨ä½“ï¼Œæ˜¯å®Œå…¨åŠ å¯†çš„ï¼Œå³ã€ç»ˆç«¯ -ğŸ”-> CF èŠ‚ç‚¹ -ğŸ”-> åº”ç”¨æœåŠ¡å™¨ã€‘ä¹‹é—´æ˜¯å®Œå…¨åŠ å¯†çš„ï¼Œ
èƒ½å¤Ÿå……åˆ†çš„ä¿è¯ä¿¡æ¯ä¼ è¾“çš„å®‰å…¨ã€‚åœ¨åº”ç”¨ HTTPS æ—¶åº”è¯¥ä¼˜å…ˆå‚è€ƒè¿™ç¯‡ï¼Œä¸è¿‡åº”å…ˆé˜…è¯»å®Œå‰ä¸€ç¯‡åå†é˜…è¯»è¿™ç¯‡ã€‚

ä¸ºäº†ä¿æŒæ–‡ç« çš„å®Œæ•´æ€§ï¼Œè¯·å®¹è®¸æˆ‘å¯¹ CF åšä¸€ç•ªç®€å•ä»‹ç»ã€‚

## 2. Cloudflare æ˜¯ä»€ä¹ˆ

- æˆç«‹æ—¶é—´ï¼š2009.7
- æ€»éƒ¨ï¼šæ—§é‡‘å±±
- åˆ›å§‹äººï¼šé©¬ä¿®Â·æ™®æ—æ–¯ï¼ˆMatthew Princeï¼‰ã€æÂ·éœæ´›éŸ¦ï¼ˆLee Hollowayï¼‰ã€ç±³æ­‡å°”Â·æ‰ç‰¹æ—ï¼ˆMichelle Zatlynï¼‰
- çŠ¶æ€ï¼šç°å·²ä¸Šå¸‚ï¼Œä¸šåŠ¡éåŠå…¨çƒï¼Œæ˜¯å…¨çƒæœ€å¤§çš„ CDN æä¾›å•†ã€‚
- æä¾›çš„æœåŠ¡ï¼š
  - CDN
  - DDoS é˜²æŠ¤
  - WAFï¼ˆWeb åº”ç”¨é˜²ç«å¢™ï¼‰
  - SSL/TLS åŠ å¯†ï¼ˆæä¾›å…è´¹å’Œé«˜çº§ SSL è¯ä¹¦ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨ï¼‰
  - 1.1.1.1ï¼ˆå…è´¹ DNS æœåŠ¡ï¼‰
  - WARP VPN
  - Zero Trust
  - åŸŸåæœåŠ¡ï¼ˆåŸŸåè§£æã€åŸŸåè´­ä¹°ï¼‰
  - Workersï¼ˆè¾¹ç¼˜è®¡ç®—ï¼‰
  - Pages
  - hCaptchaï¼ˆçœŸäººéªŒè¯ï¼‰
  - Turnstileï¼ˆhCaptcha çš„æ›¿ä»£å“ï¼‰
  - å¤§é‡å…è´¹ Email ğŸ“§
  - â€¦â€¦

## 3. Cloudflare å†å²

è¦äº†è§£ä¸ºä»€ä¹ˆè¦æœ‰ Cloudflare ä»¥åŠå…¶å…·ä½“çš„è¯¦ç»†çš„äº§å“ç»†èŠ‚è¯·è‡ªè¡ŒæŸ¥çœ‹ [Cloudflare å®˜ç½‘\[3\]][3]å’Œ[ç»´åŸºç™¾ç§‘\[4\]][4]èµ„æ–™ã€‚

ä¸ºäº†å†…å®¹çš„å®Œæ•´æ€§ï¼Œæˆ‘å†å°†é—®é¢˜æè¿°ä¸€éã€‚

## 4. é—®é¢˜æè¿°

### 4.1. é—®é¢˜ä¸€

è¿™æ˜¯æˆ‘é‡åˆ°çš„ä¸€ä¸ªçœŸå®é—®é¢˜ã€‚æˆ‘æœ‰ä¸€å°äºšé©¬é€Šçš„ VPSï¼Œå…ˆå‰å·²åœ¨ä¸Šé¢éƒ¨ç½²äº† [Gost\[5\]][5]ï¼Œå¹¶åœ¨åº”ç”¨å†…
é€šè¿‡ certbot ç”³è¯·å¹¶ä½¿ç”¨äº†è¯ä¹¦ï¼Œå ç”¨äº† 443 ç«¯å£ï¼Œæ²¡æœ‰ä½¿ç”¨ Nginx ç­‰å·¥å…·ã€‚

ç°åœ¨æˆ‘éœ€è¦åœ¨ä¸Šé¢å†éƒ¨ç½²ä¸€ä¸ª web åº”ç”¨ [Memos\[6\]][6]ï¼Œè¿™ä¸ªåº”ç”¨æˆ‘ä½¿ç”¨äº† Nginx æ¥åšåä»£ï¼Œæˆ‘æƒ³è®©
åº”ç”¨èµ° HTTPS æ¥ä½¿ç”¨åŠ å¯†é“¾æ¥ï¼Œä½†æ˜¯ç”±äº 443 ç«¯å£ä»¥è¢« Gost å ç”¨ï¼Œå¯¼è‡´æˆ‘çš„ Nginx èµ·ä¸èµ·æ¥ï¼Œåªèƒ½
é…æˆå…¶å®ƒç«¯å£ï¼Œä½†æˆ‘åˆä¸æƒ³ä½¿ç”¨å…¶å®ƒç«¯å£ï¼Œå› ä¸ºæ¯æ¬¡éƒ½è¦åœ¨æµè§ˆå™¨é‡Œè¾“ç«¯å£å·å¾ˆéº»çƒ¦ï¼Œè¿˜å®¹æ˜“å¿˜ï¼Œè¯·é—®æˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ

### 4.2. é—®é¢˜äºŒ

å¦‚æœé…ç½®åº”ç”¨èµ° HTTPSï¼Œé‚£ä¹ˆæˆ‘éœ€è¦ç”³è¯·ä¸€ä¸ªè¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡ certbot è‡ªåŠ¨æœºå™¨äººç”³è¯· Let's Encrypt ç”³è¯·
å…è´¹çš„è¯ä¹¦ï¼Œå¯æ˜¯ä½¿ç”¨è‡ªç­¾åçš„å…è´¹è¯ä¹¦ååœ¨ç”¨æˆ·åˆæ¬¡è®¿é—®è¿™ä¸ªç½‘ç«™æ—¶ä¼šæç¤ºè®©ç”¨æˆ·å®‰è£…æˆ‘è¿™ä¸ªè¯ä¹¦ï¼Œè¿™å°±å½¢æˆäº†
çŒœç–‘é“¾ï¼Œé€šå¸¸ç”¨æˆ·é‡åˆ°è¿™ç§æƒ…å†µä¼šè­¦è§‰ï¼Œè§‰å¾—æ˜¯ä¸å®‰å…¨çš„ï¼ˆè¢«ç¬¬ä¸‰æ–¹æè¯ä¹¦åŠ«æŒæ¥è¿›è¡Œé’“é±¼ğŸ£ï¼‰ï¼Œä¼šé©¬ä¸Šå…³æ‰ï¼Œè¿™æ˜¯å¯¹çš„ï¼Œä¹Ÿåº”è¯¥æ˜¯è¿™æ ·ï¼Œæˆ‘ä¹Ÿæ˜¯è¿™æ ·ã€‚

é‚£ä¹ˆè¿˜å¯ä»¥ä»˜è´¹ç”³è¯·è¯ä¹¦ï¼Œå¯æ˜¯ä½œä¸ºç©·äººçš„æˆ‘åˆä¸æƒ³èŠ±é’±ç”³è¯·ä»˜è´¹è¯ä¹¦ï¼Œè¯·é—®æˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ

## 5. éœ€æ±‚åˆ†æ

ç•¥ã€‚

é—®é¢˜æè¿°é˜¶æ®µå·²ç»æè¿°å¾—å¾ˆæ¸…æ¥šã€‚

## 6. è§£å†³æ–¹æ¡ˆ

ä»¤äººæ²®ä¸§çš„æ˜¯ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†ä¸€æ®µæ—¶é—´ï¼Œä¸€åœˆæœ‰ä¸€åœˆï¼Œè¿˜æ˜¯æ²¡èƒ½æ‰¾åˆ°è´´åˆçš„è§£å†³æ–¹æ¡ˆã€‚

çªç„¶æƒ³åˆ°äº†è¿˜æœ‰ Cloudflare è¿™ä¸ªå¾ˆä½›å¿ƒçš„èµ›åšå¤§å–„äººï¼Œä¹‹å‰ä¹Ÿæˆ–å¤šæˆ–å°‘åœ¨ B ç«™å’Œæ²¹ç®¡çœ‹è¿‡ä¸€äº›ä»‹ç»å’Œä½¿ç”¨
CF çš„è§†é¢‘ï¼Œäºæ˜¯æ‰“å¼€ CF æ¢å¯»ä¸€ç•ªï¼Œç»ˆäºæ‰¾åˆ°äº†ç†æƒ³çš„è§£å†³æ–¹æ¡ˆï¼Œäºæ˜¯ä¾¿æœ‰äº†æ­¤æ–‡ã€‚

***Q & Aï¼š***

### 6.1. é—®é¢˜ä¸€è§£æ³•

ä¸€è¨€ä»¥è”½ä¹‹ï¼Œå°±æ˜¯å·§å¦™çš„åˆ©ç”¨ CF å¼ºå¤§è€Œåˆçµæ´»çš„è§„åˆ™é›†ã€‚

### 6.2. é—®é¢˜äºŒè§£æ³•

CF æä¾›ç”³è¯·å…è´¹è¯ä¹¦ï¼Œè¿™ä¸ªè¯ä¹¦æœ‰æ•ˆæœŸæœ€é•¿è¾¾ **15** å¹´ã€‚è¿™ä¸ªè¯ä¹¦ä½œç”¨çš„é˜¶æ®µæ˜¯ä»ã€CF -> åº”ç”¨æœåŠ¡å™¨ã€‘
è¿™ä¸ªé˜¶æ®µã€‚æˆ‘ä¸ä»…å°†åŸŸåæ‰˜ç®¡åˆ° CF ä¸Šï¼Œä½¿ç”¨ CF æ¥è¿›è¡ŒåŸŸåè§£æï¼Œè¿˜å¼€å¯äº† CF çš„ä»£ç†åŠŸèƒ½ï¼Œå³ä½¿ç”¨ CF ä½œä¸ºç”¨æˆ·çš„ä»£ç†ä¸­ä»‹æ¥è®¿é—®
æˆ‘çš„ç½‘ç«™ï¼Œè€Œ CF å¯¹è‡ªå®¶ç­¾åçš„è¯ä¹¦æ˜¯è®¤çš„ã€‚ä¸ä¼šå†å‡ºç°æµè§ˆå™¨å¼¹å‡ºå®‰å…¨æç¤ºæ¥è­¦å‘Šç”¨æˆ·ä¸è¦å®‰è£…ä¸å®‰å…¨çš„ç¬¬ä¸‰æ–¹è¯ä¹¦çš„æƒ…å†µã€‚

## 7. æ“ä½œæ­¥éª¤

- æ³¨å†Œæˆ–ç™»å½• [Cloudflare\[2\]][2] ã€‚

- æ‰˜ç®¡åŸŸååˆ° CF ä¸Šã€‚å°†åœ¨åˆ«å¤„è´­ä¹°æˆ–å…è´¹ç”³è¯·çš„åŸŸåï¼ˆä¾‹å¦‚ example.comï¼‰è¾“å…¥å¸æˆ·ä¸»é¡µçš„æ·»åŠ åŸŸé‡Œé¢ã€‚

  - å¦‚æœæ˜¯åœ¨ CF ä¸Šè´­ä¹°çš„åŸŸåï¼Œåˆ™ä¸ç”¨è¿›è¡Œè¿™æ­¥æ“ä½œï¼Œä¼šè‡ªè¡Œæ‰˜ç®¡ã€‚å»ºè®®åœ¨è¿™ä¸ªå¹³å°è´­ä¹°ï¼Œå› ä¸ºè¿™å¤§å–„äººæ‰¿è¯ºæŒ‰æˆæœ¬å®šä»·ã€‚

  - `å¸æˆ·ä¸»é¡µ[å·¦] -> æ·»åŠ åŸŸ[å³] -> å¿«é€Ÿæ‰«æ DNS è®°å½• -> Free -> ç»§ç»­å‰å¾€æ¿€æ´» -> æŒ‰é¡µé¢æç¤ºæ›¿æ¢åç§°æœåŠ¡å™¨`

- ä¸ºåº”ç”¨åˆ›å»ºå­åŸŸåï¼ˆåŸŸåè§£æï¼‰ã€‚æ·»åŠ  DNS çš„ A è®°å½•ã€‚

  - `å¸æˆ·ä¸»é¡µ[å·¦] -> ç‚¹å‡»è‡ªå·±åˆšæ‰˜ç®¡çš„åŸŸå[å³ example.com] -> DNS[å·¦] -> æ·»åŠ è®°å½•`

  - è®°å½•ç±»å‹ä¸º Aï¼Œåç§°ä¸ºæ ¹æ®è‡ªå·±çš„å®é™…è¦æ±‚é…ç½®çš„äºŒçº§åŸŸåå‰ç¼€ï¼ˆå¦‚ memosï¼‰ï¼ŒIPv4 éƒ¨åˆ†å¡«å…¥è‡ªå·±çš„æœåŠ¡å™¨åœ°å€ï¼Œ
  **å¼€å¯ä»£ç†çŠ¶æ€**ï¼ˆä¸€å®šè¦å¼€å¯ï¼Œè¿™æ˜¯æœ€é‡è¦çš„å‰ææ¡ä»¶ï¼‰ï¼Œä¿å­˜ï¼Œå‡ åˆ†é’Ÿåå°±ä¼šç”Ÿæ•ˆã€‚

- ç”³è¯·è¯ä¹¦ã€‚

  - `å¸æˆ·ä¸»é¡µ -> æ‰˜ç®¡çš„åŸŸå -> SSL/TLS -> æºæœåŠ¡å™¨ -> åˆ›å»ºè¯ä¹¦ -> åˆ›å»º`

  - åˆ†åˆ«å¤åˆ¶æºè¯ä¹¦å’Œç§é’¥åˆ°æœ¬åœ°æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¹¶åˆ†åˆ«å‘½åä¸º `<åŸŸå>.pem` å’Œ `<åŸŸå>.key` ï¼ˆå°–æ‹¬å·éƒ¨åˆ†æ›¿æ¢ä¸ºè‡ªå·±çš„å†…å®¹ï¼Œä¸‹åŒï¼‰ï¼Œ
  å¦‚ `memos.example.com.pem`ã€`memos.example.com.key`ã€‚

  - ç¡®å®šã€‚

- ç™»å½• VPS æœåŠ¡å™¨ï¼ˆæ­¤å¤„ä¸º Linux æœåŠ¡å™¨ Ubuntuï¼Œå…¶å®ƒæ–¹å¼åŒç†ï¼‰ã€‚

- åœ¨æœåŠ¡å™¨ä¸Šå¼€å¯åº”ç”¨ï¼ˆmemosï¼‰ è¦ä½¿ç”¨çš„ HTTPS ç«¯å£ï¼ˆé»˜è®¤æ˜¯ä½¿ç”¨ 443ï¼Œä¹‹æ‰€ä»¥è¦ç»‘å®šå…¶å®ƒç«¯å£æ˜¯å› ä¸ºè¢«å…¶å®ƒåº”ç”¨å ç”¨ï¼ˆå¦‚ Gostï¼‰ï¼‰ã€‚

  - æœ‰çš„å¹³å°ï¼ˆå¦‚ AWSï¼‰é»˜è®¤æ˜¯é€šè¿‡åœ¨å…¶ç½‘ç«™ä¸Šé€šè¿‡æ·»åŠ å®‰å…¨ç»„æ¥å¼€æ”¾ç«¯å£ï¼ˆä¸æ¿€æ´» ufwï¼‰ï¼Œå¦‚æœæ˜¯åˆ™è‡ªè¡Œæ·»åŠ ï¼Œè·³è¿‡ä»¥ä¸‹æ­¥éª¤ï¼Œå¦åˆ™ç»§ç»­ä»¥ä¸‹æ­¥éª¤ï¼ˆDigitalOceanã€Linodeï¼‰ã€‚

  - é€šå¸¸å¯ä»¥é€šè¿‡ Ubuntu çš„é»˜è®¤é˜²ç«å¢™æ¥å¼€å¯ç«¯å£ï¼ˆå…¶å®ƒ Linux ç³»ç»Ÿå¯é€šè¿‡ firewalld(Red Hatã€CentOS)ã€nftables ç­‰æ¥å¯ç”¨ç«¯å£ï¼Œ
  å¦‚æœä¸ç¡®å®šåˆ™å¯ä»¥ä½¿ç”¨æ›´å…¨é¢ä½†æ›´å¤æ‚çš„ Linux å†…æ ¸ç›´æ¥æ­è½½çš„ iptablesï¼‰ã€‚

  - æŸ¥çœ‹æ˜¯å¦å·²æ¿€æ´» ufwï¼š`sudo ufw status verbose`

  - å¦‚æœæ²¡æ¿€æ´»åˆ™æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¿€æ´»ï¼Œå¦åˆ™è·³è¿‡è¿™æ­¥ã€‚

    ```bash
    sudo ufw allow ssh
    sudo ufw enable
    ```

  - å¼€æ”¾ç«¯å£ï¼ˆæ­¤å¤„ä¸º 8443ï¼Œä½ ä¹Ÿå¯ä»¥é…ç½®è‡ªå·±çš„å…¶å®ƒç«¯å£ï¼‰ï¼š`sudo ufw allow <8443>`

- å®‰è£… Nginxï¼š`sudo apt install nginx`ã€‚

- ä¸Šä¼ è¯ä¹¦åˆ°æœåŠ¡å™¨ï¼ˆæˆ‘ä½¿ç”¨çš„å®¢æˆ·ç«¯æ˜¯ Macï¼ŒVPS æ˜¯ AWS lightsailï¼‰ã€‚

  - æ‰“å¼€ç»ˆç«¯å¹¶æ‰§è¡Œå‘½ä»¤ï¼Œå…ˆä¸Šä¼ åˆ° tmp æ–‡ä»¶å¤¹å†ç§»åŠ¨åˆ° Nginx çš„ ssl æ–‡ä»¶å¤¹ã€‚ä¸­æ‹¬å·éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œ
    `-i` åé¢çš„å‚æ•°æ˜¯ç™»å½• VPS çš„å¯†é’¥ï¼Œå¦‚æœæ˜¯è¾“å…¥å¯†ç åˆ™ä¸éœ€è¦æŒ‡å®šè¿™ä¸ªå‚æ•°ã€‚(å°–æ‹¬å·éƒ¨åˆ†éœ€è¦æ›¿æ¢ä¸ºè‡ªå·±çš„åœ°å€ï¼Œä¸‹åŒ)

    ```zsh
    scp [-i ~/.ssh/loginKey.pem] <~/Downloads/memos.example.com.pem> <ubuntu@memos.example.com>:/tmp/
    scp [-i ~/.ssh/loginKey.pem] <~/Downloads/memos.example.com.key> <ubuntu@memos.example.com>:/tmp/
    ssh [-i ~/.ssh/loginKey.pem] <ubuntu@memos.example.com> "sudo mv /tmp/<memos.example.com.pem> /etc/nginx/ssl/ && sudo mv /tmp/<memos.example.com.key> /etc/nginx/ssl/"
    ```

- ç™»å½•æœåŠ¡å™¨å¹¶è®¾ç½®è¯ä¹¦å’Œå¯†é’¥æƒé™ã€‚

  ```bash
  sudo chown root:root /etc/nginx/ssl/<memos.example.com.pem> /etc/nginx/ssl/<memos.example.com.key>
  sudo chmod 644 /etc/nginx/ssl/<memos.example.com.pem>
  sudo chmod 600 /etc/nginx/ssl/<memos.example.com.key>
  ```

- é…ç½®å¯¹åº”ç½‘ç«™çš„ Nginx é…ç½®æ–‡ä»¶ã€‚è¿›å…¥ `/etc/nginx/sites-available/` ç›®å½•å¹¶åˆ›å»ºå¯¹åº”ç½‘ç«™çš„é…ç½®æ–‡ä»¶ <memos.example.com>ã€‚

  ```bash
  cd /etc/nginx/sites-available
  touch <memos.example.com>
  ```

- æ·»åŠ é…ç½®ã€‚å¡«å…¥ä»¥ä¸‹é…ç½®ä¿¡æ¯ï¼š

  ```bash
  server {
    listen <8443> ssl;
    server_name <memos.example.com>;

    ssl_certificate /etc/nginx/ssl/<memos.example.com.pem>;
    ssl_certificate_key /etc/nginx/ssl/<memos.example.com.key>;

    location / {
      proxy_pass <http://localhost:5230>;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
      root /usr/share/nginx/html;
    }
  }
  ```

- å°†é…ç½®æ–‡ä»¶é“¾æ¥åˆ° Nginx çš„æ‰§è¡Œç›®å½•ã€‚

  ```bash
  sudo ln -s /etc/nginx/sites-available/<memos.example.com> /etc/nginx/sites-enabled/<memos.example.com>
  ```

- æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•ï¼š`sudo nginx -t`

- ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆã€‚

  - æŸ¥çœ‹ Nginx çŠ¶æ€ï¼š`sudo systemctl status nginx`

  - å¦‚æœæ˜¯æœªå¯åŠ¨åˆ™å¯åŠ¨ï¼š`sudo systemctl start nginx`

  - å¦‚æœå·²å¯åŠ¨äº†åˆ™é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼š`sudo nginx -s reload`

- **ä¿®æ”¹ SSL/TLS åŠ å¯†æ¨¡å¼**ã€‚

  `å¸æˆ·ä¸»é¡µ -> æ‰˜ç®¡åŸŸå<example.com> -> SSL/TLS -> æ¦‚è¿° -> SSL/TLS é…ç½® -> è‡ªå®šä¹‰ SSL/TLS -> é€‰ä¸­ å®Œå…¨ï¼ˆä¸¥æ ¼ï¼‰é€‰é¡¹å¹¶ä¿å­˜`

  ![Secret Mode Image](/assets/images/cloudflare/cf-secret-mode.webp "åŠ å¯†æ¨¡å¼")

- å‹¾é€‰è¾¹ç¼˜è¯ä¹¦é‡Œé¢çš„é€‰é¡¹ï¼ˆå¯é€‰ï¼‰ã€‚

  `å¸æˆ·ä¸»é¡µ -> æ‰˜ç®¡åŸŸå<example.com> -> SSL/TLS -> æ¦‚è¿°`

  - å‹¾é€‰âœ…å³è¾¹ğŸ‘‰çš„ **å§‹ç»ˆä½¿ç”¨ HTTPS**ã€**TLS 1.3**ã€**è‡ªåŠ¨ HTTPS é‡å†™**

- WAFï¼ˆWeb åº”ç”¨é˜²ç«å¢™ï¼‰é…ç½®ï¼ˆå¯é€‰ï¼‰ã€‚

  - `å¸æˆ·ä¸»é¡µ -> æ‰˜ç®¡åŸŸå<example.com> -> å®‰å…¨æ€§ -> WAF`

    - è‡ªå®šä¹‰è§„åˆ™

      ![Self custom rule](/assets/images/cloudflare/cf-customrule-badreq.webp "è‡ªå®šä¹‰è§„åˆ™ æ¶æ„è¯·æ±‚")

    - é€Ÿç‡é™åˆ¶è§„åˆ™

      ![IP access speed rate limit 1](/assets/images/cloudflare/cf-iprate-limit01.webp)
      ![IP access speed rate limit 2](/assets/images/cloudflare/cf-iprate-limit02.webp)

- å®‰å…¨æ€§è®¾ç½®ï¼ˆå¯é€‰ï¼‰ã€‚

  - `å¸æˆ·ä¸»é¡µ -> æ‰˜ç®¡åŸŸå<example.com> -> å®‰å…¨æ€§ -> è®¾ç½®`ï¼Œå®‰å…¨çº§åˆ«è®¾ä¸ºğŸ€„ï¸ï¼Œè´¨è¯¢é€šè¿‡æœŸè®¾ä¸º
  30 åˆ†é’Ÿï¼Œç„¶åå‹¾é€‰ä¸Š æµè§ˆå™¨å®Œæ•´æ€§æ£€æŸ¥ å’Œ æ›¿æ¢ä¸å®‰å…¨çš„ JavaScript åº“ã€‚

- **ç«¯å£æ˜ å°„è§„åˆ™æ·»åŠ **ã€‚

  - `å¸æˆ·ä¸»é¡µ -> æ‰˜ç®¡åŸŸå<example.com> -> è§„åˆ™ -> æ¦‚è¿° -> åˆ›å»ºè§„åˆ™`

      ![Traffic forward rule 1](/assets/images/cloudflare/cf-traffic-forward-rule01.webp)
      ![Traffic forward rule 2](/assets/images/cloudflare/cf-traffic-forward-rule02.webp)

## 8. å‚è€ƒ

- \[1]: <https://meiyingqishi.github.io/ç¬”è®°/2024/12/19/Cloudflareæ¢ç´¢ä¹‹è®©æµè§ˆå™¨æ˜¾ç¤ºå®‰å…¨è®¿é—®ç½‘é¡µ.html>
- \[2]: <https://www.cloudflare.com/zh-cn>
- \[3]: <https://www.cloudflare.com/zh-cn/our-story>
- \[4]: <https://en.wikipedia.org/wiki/Cloudflare>
- \[5]: <https://blog.thomasyang.nl/ç§‘å­¦ä¸Šç½‘/2023/05/20/ç§‘å­¦ä¸Šç½‘ä¹‹Gostæ–¹æ¡ˆv2.html>
- \[6]: <https://memos.thomasyang.nl>

[1]: https://meiyingqishi.github.io/ç¬”è®°/2024/12/19/Cloudflareæ¢ç´¢ä¹‹è®©æµè§ˆå™¨æ˜¾ç¤ºå®‰å…¨è®¿é—®ç½‘é¡µ.html
[2]: https://www.cloudflare.com/zh-cn
[3]: https://www.cloudflare.com/zh-cn/our-story
[4]: https://en.wikipedia.org/wiki/Cloudflare
[5]: https://meiyingqishi.github.io/ç§‘å­¦ä¸Šç½‘/2023/05/20/ç§‘å­¦ä¸Šç½‘ä¹‹Gostæ–¹æ¡ˆv2.html
[6]: https://memos.thomasyang.nl
