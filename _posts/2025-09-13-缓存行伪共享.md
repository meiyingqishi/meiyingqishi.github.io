---
layout: post
title: ç¼“å­˜è¡Œä¼ªå…±äº«
date: 2025-09-13 20:00:00 +0800
categories: è½¯ä»¶å·¥ç¨‹
---

![The image of false sharing](/assets/images/false-sharing.webp)

### 1. èƒŒæ™¯ï¼šCPU ç¼“å­˜ä¸ Cache Line

* **CPU ç¼“å­˜**æ˜¯ä¸ºäº†åŠ é€Ÿå†…å­˜è®¿é—®å¼•å…¥çš„é«˜é€Ÿå­˜å‚¨ã€‚
* ç¼“å­˜ä¸æ˜¯ä¸€å­—èŠ‚ä¸€å­—èŠ‚åŠ è½½ï¼Œè€Œæ˜¯ä»¥ **ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰** ä¸ºå•ä½ï¼Œå¸¸è§å¤§å°æ˜¯ **64 å­—èŠ‚**ã€‚
* å½“ CPU è®¿é—®æŸä¸ªå˜é‡æ—¶ï¼Œæ•´ä¸ªç¼“å­˜è¡Œï¼ˆåŒ…å«è¿™ä¸ªå˜é‡å‘¨å›´çš„æ•°æ®ï¼‰éƒ½ä¼šè¢«åŠ è½½åˆ° CPU ç¼“å­˜ä¸­ã€‚

### 2. ä»€ä¹ˆæ˜¯ä¼ªå…±äº«ï¼Ÿ

**ä¼ªå…±äº«**æ˜¯æŒ‡ï¼š

* ä¸¤ä¸ªæˆ–å¤šä¸ª **é€»è¾‘ä¸Šäº’ä¸ç›¸å…³** çš„å˜é‡ï¼ˆä¾‹å¦‚é˜Ÿåˆ—çš„ `head` å’Œ `tail` æŒ‡é’ˆï¼‰ï¼Œåœ¨ **ç‰©ç†å†…å­˜ä¸Šç›¸é‚»**ï¼Œä»è€Œè½åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œé‡Œã€‚
* å¦‚æœä¸åŒçº¿ç¨‹åˆ†åˆ«æ“ä½œè¿™äº›å˜é‡ï¼Œç”±äºç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESI ç­‰ï¼‰çš„å­˜åœ¨ï¼š

  * ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ `a`ï¼Œä¼šè®©æ•´ä¸ªç¼“å­˜è¡Œå¤±æ•ˆï¼›
  * å¦ä¸€ä¸ªçº¿ç¨‹å³ä½¿åªè¯»/å†™ `b`ï¼Œä¹Ÿå¿…é¡»é‡æ–°ä»å†…å­˜åŒæ­¥ç¼“å­˜è¡Œã€‚
* ç»“æœå°±æ˜¯ **ä¸å¿…è¦çš„ç¼“å­˜è¡Œå¤±æ•ˆä¸åŒæ­¥å¼€é”€**ï¼Œæå¤§å½±å“å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½ã€‚

ğŸ“Œ **å…³é”®è¯**ï¼šå…±äº«ç¼“å­˜è¡Œï¼Œä½†é€»è¾‘ä¸Šä¸è¯¥å…±äº« â€”â€” æ‰€ä»¥å« â€œä¼ªå…±äº«â€ã€‚

### 3. ä¸¾ä¸ªä¾‹å­

å‡è®¾ç¼“å­˜è¡Œå¤§å°ä¸º 64 å­—èŠ‚ï¼š

```java
class Example {
    volatile long a;  // 8 å­—èŠ‚
    volatile long b;  // 8 å­—èŠ‚
}
```

* `a` å’Œ `b` åœ¨å†…å­˜ä¸Šæ˜¯è¿ç»­çš„ï¼ˆå…±å  16 å­—èŠ‚ï¼‰ã€‚
* å¦‚æœå®ƒä»¬è¢«ä¸åŒçº¿ç¨‹é¢‘ç¹ä¿®æ”¹ï¼Œå°±ä¼šè½åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œã€‚
* å³ä½¿çº¿ç¨‹ 1 åªæ”¹ `a`ï¼Œçº¿ç¨‹ 2 åªæ”¹ `b`ï¼Œå®ƒä»¬ä¹Ÿä¼šäº’ç›¸å¹²æ‰°ï¼ˆç¼“å­˜è¡Œå¤±æ•ˆï¼‰ã€‚

### 4. å¦‚ä½•è§£å†³ä¼ªå…±äº«

å¸¸è§æ–¹æ³•æ˜¯ **å¡«å……ï¼ˆpaddingï¼‰**ï¼Œè®©ä¸åŒå˜é‡ä¸è½åœ¨åŒä¸€ç¼“å­˜è¡Œï¼š

#### (1) æ‰‹å·¥å¡«å……å­—æ®µ

```java
class Example {
    volatile long a;
    long p1, p2, p3, p4, p5, p6, p7;  // å¡«å……ï¼Œé˜²æ­¢ b ä¸ a åŒä¸€è¡Œ
    volatile long b;
}
```

#### (2) ä½¿ç”¨æ³¨è§£ `@sun.misc.Contended`ï¼ˆJDK 8+ï¼‰*

```java
@sun.misc.Contended
class Example {
    volatile long a;
    volatile long b;
}
```

* `@Contended` ä¼šåœ¨å­—æ®µå‰åè‡ªåŠ¨åŠ ä¸Šå¡«å……å­—èŠ‚ï¼Œä¿è¯å®ƒä»¬åˆ†ç¦»åœ¨ä¸åŒç¼“å­˜è¡Œã€‚
* éœ€è¦ JVM å‚æ•° `-XX:-RestrictContended` å¯ç”¨ã€‚

**âš ï¸ è­¦å‘Šï¼šæ­¤æ–¹æ³•åœ¨é«˜ç‰ˆæœ¬ JDK ä¸­å·²è¿‡æ—¶ï¼ˆæˆ‘æµ‹è¯•ä½¿ç”¨çš„æ˜¯ OpenJDK 24ï¼‰ï¼Œä¸èƒ½å†ä½¿ç”¨äº†ï¼Œ
å³ä½¿ä½¿ç”¨ `@jdk.internal.vm.annotation.Contended` ï¼ˆJDK 9+ï¼‰ä¹Ÿä¸è¡Œï¼Œè¿™ä¹Ÿæ˜¯å†…éƒ¨ APIï¼Œ
å®˜æ–¹ä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ã€‚å»ºè®®ä½¿ç”¨ç¬¬ä¸€ç§æ‰‹åŠ¨å¡«å……æˆ–ç¬¬ä¸‰æ–¹åº“ï¼ˆJCToolsï¼‰**

### 5. ä»€ä¹ˆæ—¶å€™ä¼šé‡åˆ°ä¼ªå…±äº«ï¼Ÿ

* é«˜å¹¶å‘é˜Ÿåˆ—çš„ `head` / `tail` æŒ‡é’ˆï¼ˆç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼‰ã€‚
* è®¡æ•°å™¨æ•°ç»„ï¼ˆä¾‹å¦‚ç»Ÿè®¡è¯·æ±‚æ•°çš„åœºæ™¯ï¼‰ã€‚
* è‡ªæ—‹é”ã€åŸå­å˜é‡ç­‰é«˜é¢‘ä¿®æ”¹çš„å…±äº«æ•°æ®ç»“æ„ã€‚

### 6. æ€»ç»“

* **ä¼ªå…±äº«ä¸æ˜¯â€œå…±äº«æ•°æ®â€ï¼Œè€Œæ˜¯â€œå…±äº«ç¼“å­˜è¡Œâ€** å¯¼è‡´çš„é—®é¢˜ã€‚
* æœ¬è´¨åŸå› ï¼šç¼“å­˜ä¸€è‡´æ€§åè®® + å†…å­˜æ’å¸ƒç´§å¯†ã€‚
* è§£å†³æ€è·¯ï¼š**é¿å…çƒ­ç‚¹å˜é‡å¤„äºåŒä¸€ä¸ªç¼“å­˜è¡Œ**ï¼ˆpadding æˆ– `@Contended`ï¼‰ã€‚

---
---

é€šè¿‡ä»¥ä¸‹å¸¦ä¼ªå…±äº«å’Œå»ä¼ªå…±äº«å¯¹æ¯”çš„ Java Benchmark ä»£ç ï¼ˆJMHï¼‰ï¼Œè®©æˆ‘ä»¬ç›´è§‚çœ‹çœ‹æ€§èƒ½å·®è·ï¼š

### JMH åŸºå‡†æµ‹è¯•ä»£ç 

åˆ›å»ºä¸€ä¸ª Maven é¡¹ç›®ï¼Œå¹¶æ·»åŠ  JMH ä¾èµ–ã€‚

#### 1. Maven ä¾èµ– (`pom.xml`)

```xml
<project ...>
    <properties>
        <maven.compiler.source>24</maven.compiler.source>
        <maven.compiler.target>24</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.openjdk.jmh</groupId>
            <artifactId>jmh-core</artifactId>
            <version>1.37</version>
        </dependency>
        <dependency>
            <groupId>org.openjdk.jmh</groupId>
            <artifactId>jmh-generator-annprocess</artifactId>
            <version>1.37</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>
</project>
```

#### 2. Java Benchmark ä»£ç 

è¿™ä¸ªç±»åŒ…å«äº†ä¸¤ç§æƒ…å†µçš„æµ‹è¯•ï¼š

* **`StateWithFalseSharing`**: ä¸¤ä¸ª `volatile long` å˜é‡ç´§æŒ¨ç€ï¼Œææ˜“äº§ç”Ÿä¼ªå…±äº«ã€‚
* **`StateWithoutFalseSharing`**: åœ¨ä¸¤ä¸ª `volatile long` å˜é‡ä¹‹é—´å¡«å……äº† 7 ä¸ª `long` ä½œä¸ºâ€œå«æ–™â€ï¼Œé¿å…äº†ä¼ªå…±äº«ã€‚

```java
import org.openjdk.jmh.annotations.*;
import org.openjdk.jmh.infra.ThreadParams;
import org.openjdk.jmh.runner.Runner;
import org.openjdk.jmh.runner.RunnerException;
import org.openjdk.jmh.runner.options.Options;
import org.openjdk.jmh.runner.options.OptionsBuilder;

import java.util.concurrent.TimeUnit;

@BenchmarkMode(Mode.Throughput) // æµ‹è¯•æ¨¡å¼ï¼šååé‡ (æ¯ç§’æ“ä½œæ•°)
@OutputTimeUnit(TimeUnit.SECONDS) // è¾“å‡ºç»“æœçš„æ—¶é—´å•ä½ï¼šç§’
@Warmup(iterations = 5, time = 1) // é¢„çƒ­ï¼š5è½®ï¼Œæ¯è½®1ç§’
@Measurement(iterations = 5, time = 1) // æµ‹é‡ï¼š5è½®ï¼Œæ¯è½®1ç§’
@Fork(1) // Fork å‡ºä¸€ä¸ªè¿›ç¨‹è¿›è¡Œæµ‹è¯•
@State(Scope.Group) // çŠ¶æ€çš„ä½œç”¨åŸŸï¼ŒGroup ä½œç”¨åŸŸä¿è¯åŒä¸€ç»„çš„çº¿ç¨‹å…±äº«å®ä¾‹
public class FalseSharingBenchmark {

    /**
     * å­˜åœ¨ä¼ªå…±äº«é—®é¢˜çš„çŠ¶æ€ç±»
     *
     * value1 å’Œ value2 å¾ˆå¯èƒ½åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œ (64 å­—èŠ‚) ä¸­
     * å› ä¸º long æ˜¯ 8 å­—èŠ‚ï¼Œä¸¤ä¸ª long æ˜¯ 16 å­—èŠ‚ï¼Œè¿œå°äº 64 å­—èŠ‚
     * æ·»åŠ  @State æ³¨è§£ï¼ŒScope.Group è¡¨ç¤ºåŒä¸€ç»„çš„çº¿ç¨‹å…±äº«æ­¤å®ä¾‹
     */
    @State(Scope.Group)
    public static class StateWithFalseSharing {
        public volatile long value1 = 0;
        public volatile long value2 = 0;
    }

    /**
     * é€šè¿‡ç¼“å­˜è¡Œå¡«å……è§£å†³äº†ä¼ªå…±äº«é—®é¢˜çš„çŠ¶æ€ç±»
     */
    @State(Scope.Group)
    public static class StateWithoutFalseSharing {
        public volatile long value1 = 0;

        // å¡«å…… 7 ä¸ª long å†åŠ ä¸Šå‰ä¸€ä¸ª long (7 * 8 + 1 * 8 = 64 å­—èŠ‚)ï¼Œè¶…è¿‡ä¸€ä¸ªç¼“å­˜è¡Œçš„å¤§å°ï¼ˆé€šå¸¸ä¸€ä¸ªç¼“å­˜è¡Œæ˜¯ 64 å­—èŠ‚ï¼‰
        // ç¡®ä¿ value1 å’Œ value2 è½åœ¨ä¸åŒçš„ç¼“å­˜è¡Œ
        private long p1, p2, p3, p4, p5, p6, p7;

        public volatile long value2 = 0;
    }

    // --------------- åŸºå‡†æµ‹è¯•æ–¹æ³• ---------------

    @Benchmark
    @Group("FalseSharing") // å°†ä¸¤ä¸ªçº¿ç¨‹çš„æ“ä½œå½’ä¸ºä¸€ç»„
    @GroupThreads(2) // ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹
    public void testFalseSharing(StateWithFalseSharing state, ThreadParams threadParams) {
        // æ ¹æ®çº¿ç¨‹ç´¢å¼•ï¼Œè®©ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¿®æ”¹ä¸åŒçš„å˜é‡
        if (threadParams.getThreadIndex() == 0) {
            state.value1++;
        } else {
            state.value2++;
        }
    }

    @Benchmark
    @Group("NoFalseSharing") // å°†ä¸¤ä¸ªçº¿ç¨‹çš„æ“ä½œå½’ä¸ºå¦ä¸€ç»„
    @GroupThreads(2) // åŒæ ·ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹
    public void testNoFalseSharing(StateWithoutFalseSharing state, ThreadParams threadParams) {
        // æ ¹æ®çº¿ç¨‹ç´¢å¼•ï¼Œè®©ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«ä¿®æ”¹ä¸åŒçš„å˜é‡
        if (threadParams.getThreadIndex() == 0) {
            state.value1++;
        } else {
            state.value2++;
        }
    }

    public static void main(String[] args) throws RunnerException {
        Options opt = new OptionsBuilder()
                .include(FalseSharingBenchmark.class.getSimpleName())
                .build();

        new Runner(opt).run();
    }
}

```

### å¦‚ä½•è¿è¡Œ

1. å°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°ä½ çš„ Maven é¡¹ç›®çš„ `src/main/java` ç›®å½•ä¸‹ã€‚
2. ä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼š`mvn clean package`
3. å¯ä»¥ç›´æ¥åœ¨ IDE ä¸­è¿è¡Œ `main` æ–¹æ³•ï¼Œæˆ–è€…æ‰§è¡Œæ‰“åŒ…åçš„ jar æ–‡ä»¶ã€‚

### é¢„æœŸç»“æœåˆ†æ

å½“ä½ è¿è¡Œè¿™ä¸ªåŸºå‡†æµ‹è¯•åï¼Œä½ ä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼ˆå…·ä½“æ•°å€¼å–å†³äºä½ çš„æœºå™¨é…ç½®ï¼Œä»¥ä¸‹æ˜¯æˆ‘åœ¨ M1 Pro Mac ä¸‹å¾—åˆ°çš„è¾“å‡ºï¼Œ
éä¼ªå…±äº«ç‰ˆæ¯”ä¼ªå…±äº«ç‰ˆæ€§èƒ½é«˜ 4 å€ä»¥ä¸Šï¼‰ï¼š

```plaintext
Benchmark                              Mode  Cnt          Score          Error  Units
FalseSharingBenchmark.FalseSharing    thrpt    5   75292908.335 Â± 17920363.242  ops/s
FalseSharingBenchmark.NoFalseSharing  thrpt    5  329029833.864 Â±  1406771.525  ops/s
```

**ç»“æœè§£è¯»**:

* **`FalseSharing` ç»„**: ååé‡ï¼ˆScoreï¼‰éå¸¸ä½ã€‚è¿™æ˜¯å› ä¸ºä¸¤ä¸ªçº¿ç¨‹åœ¨ä¸æ–­åœ°ä¿®æ”¹ä½äºåŒä¸€ç¼“å­˜è¡Œçš„ `value1` å’Œ `value2`ã€‚çº¿ç¨‹ A ä¿®æ”¹ `value1`ï¼Œå¯¼è‡´çº¿ç¨‹ B æ‰€åœ¨çš„ CPU æ ¸å¿ƒçš„ç¼“å­˜è¡Œå¤±æ•ˆï¼›ç´§æ¥ç€çº¿ç¨‹ B ä¿®æ”¹ `value2`ï¼Œåˆå¯¼è‡´çº¿ç¨‹ A çš„ç¼“å­˜è¡Œå¤±æ•ˆã€‚è¿™ç§æ¥å›çš„â€œç¼“å­˜åŒæ­¥â€ä¸¥é‡æ‹–æ…¢äº†æ‰§è¡Œé€Ÿåº¦ã€‚
* **`NoFalseSharing` ç»„**: ååé‡éå¸¸é«˜ï¼Œå¯èƒ½æ˜¯å‰è€…çš„**4 åˆ° 10 å€ç”šè‡³æ›´é«˜**ã€‚è¿™æ˜¯å› ä¸ºé€šè¿‡å¡«å……å­—èŠ‚ï¼Œ`value1` å’Œ `value2` è¢«å¼ºåˆ¶åˆ†é…åˆ°äº†ä¸åŒçš„ç¼“å­˜è¡Œã€‚çº¿ç¨‹ A ä¿®æ”¹ `value1` ä¸ä¼šå½±å“çº¿ç¨‹ B ç¼“å­˜çš„ `value2`ï¼Œåä¹‹äº¦ç„¶ã€‚ä¸¤ä¸ªçº¿ç¨‹å¯ä»¥çœŸæ­£åœ°å¹¶è¡Œæ‰§è¡Œï¼Œæ€§èƒ½è‡ªç„¶å¤§å¹…æå‡ã€‚

è¿™ä¸ª Benchmark éå¸¸ç›´è§‚åœ°é‡åŒ–äº†ä¼ªå…±äº«å¸¦æ¥çš„æ€§èƒ½æƒ©ç½šï¼Œä»¥åŠé€šè¿‡ç®€å•çš„å†…å­˜å¸ƒå±€ä¼˜åŒ–ï¼ˆå»ä¼ªå…±äº«ï¼‰æ‰€èƒ½è·å¾—çš„å·¨å¤§æ€§èƒ½æ”¶ç›Šã€‚
